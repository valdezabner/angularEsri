(window.webpackJsonp=window.webpackJsonp||[]).push([[138],{mRf7:function(e,t,r){"use strict";r.r(t);var n=r("HaE+"),i=r("pO5D"),a=(r("wSAH"),r("srIe")),o=r("6S2I"),s=r("zqDF"),l=r("WbKI"),c=r("+opI"),u=r("RI0u"),f=r("r88o"),d=r("04ZG"),p=r("zlDU"),m=r("4EHJ"),h=(r("ju1D"),r("9AIY"),r("SFah")),y=r("pqNC"),b=r("5pQd"),g=r("IvSi"),x=r("uRH/"),O=r("ukD5"),v=r("ofM5"),I=r("mXvl"),j=r("DbUH"),w=r("jhcG"),S=r("WmKv"),T=r("9Ruv"),R=r("Stxv"),C=r("f4Nx"),_=r("WZb1"),M=r("OvF4"),k=(r("4GrV"),r("Lqtk")),F=r("VLTf"),P=r("3/ME"),D=r("tidM"),B=r("2mvb"),N=r("HM2S"),H=r("ciAr");const z=o.a.getLogger("esri.layers.mixins.ImageryTileMixin"),L=e=>{let t=class extends e{constructor(){super(...arguments),this._rasterJobHandler={instance:null,refCount:0,connectionPromise:null},this.bandIds=null,this.copyright=null,this.fullExtent=null,this.interpolation="nearest",this.raster=null,this.rasterInfo=null,this.sourceJSON=null,this.spatialReference=null,this.tileInfo=null,this.symbolizer=null}set multidimensionalDefinition(e){this.raster&&(this._sliceId=this.raster.getSliceIndex(e)),this._set("multidimensionalDefinition",e)}set url(e){this._set("url",Object(F.g)(e,z))}set renderer(e){this._set("renderer",e),this.updateRenderer()}updateRenderer(){var e=this;return Object(n.a)(function*(){if(!e.loaded)return;if(JSON.stringify(e._cachedRendererJson)===JSON.stringify(e.renderer))return;const t=e._rasterJobHandler.instance;t&&(e.symbolizer.rendererJSON=Object(N.e)(e.renderer.toJSON()),e.symbolizer.bind(),yield t.updateSymbolizer(e.symbolizer),e._cachedRendererJson=e.renderer.toJSON())})()}applyRenderer(e,t){var r=this;return Object(n.a)(function*(){const n=e&&e.pixelBlock;if(!(n&&n.pixels&&n.pixels.length>0))return null;let i;r.updateRenderer();const a=r._rasterJobHandler.instance,{bandIds:o}=r;return i=a?yield a.symbolize({...e,simpleStretchParams:t,bandIds:o}):r.symbolizer.symbolize({...e,simpleStretchParams:t,bandIds:o}),i})()}getTileUrl(e,t,r){return"RasterTileServer"===this.raster.datasetFormat?`${this.url}/tile/${e}/${t}/${r}`:""}getCompatibleTileInfo(e,t){if(!this.loaded)return null;const r=Object(C.d)(e);return P.a.create({size:256,spatialReference:e,origin:r?{x:r.origin[0],y:r.origin[1]}:{x:t.xmin,y:t.ymax}})}getCompatibleFullExtent(e){return this.loaded?(this._compatibleFullExtent&&this._compatibleFullExtent.spatialReference.equals(e)||(this._compatibleFullExtent=this.raster.computeExtent(e)),this._compatibleFullExtent):null}fetchTile(e,t,r,i={}){var a=this;return Object(n.a)(function*(){if(i.requestAsImageElement){const n=a.getTileUrl(e,t,r);return Object(k.default)(n,{responseType:"image",query:{sliceId:a._sliceId,_ts:i.timestamp},signal:i.signal}).then(e=>e.data)}return yield a._initJobHandler(),a.multidimensionalDefinition&&(i={multidimensionalDefinition:a.multidimensionalDefinition,sliceId:a._sliceId,buffer:"raster-shaded-relief"===a.renderer.type?{cols:1,rows:1}:null,...i}),a.raster.fetchTile(e,t,r,i)})()}fetchPixels(e,t,r,i){var a=this;return Object(n.a)(function*(){return yield a._initJobHandler(),a.multidimensionalDefinition&&(i={multidimensionalDefinition:a.multidimensionalDefinition,sliceId:a._sliceId,...i}),a.raster.fetchPixels(e,t,r,i)})()}identify(e,t={}){return this.multidimensionalDefinition&&!t.multidimensionalDefinition&&(t={...t,multidimensionalDefinition:this.multidimensionalDefinition}),this.raster.identify(e,t)}increaseRasterJobHandlerUsage(){this._rasterJobHandler.refCount++}decreaseRasterJobHandlerUsage(){this._rasterJobHandler.refCount--,this._rasterJobHandler.refCount<=0&&this._shutdownJobHandler()}_configDefaultSettings(){this._configDefaultInterpolation(),this._configDefaultSlice(),this._configDefaultRenderer()}_initJobHandler(){if(null!=this._rasterJobHandler.connectionPromise)return this._rasterJobHandler.connectionPromise;const e=new B.a;return this._rasterJobHandler.connectionPromise=e.initialize().then(()=>{this._rasterJobHandler.instance=e,this.raster.rasterJobHandler=e,this.renderer&&this.updateRenderer()}).catch(()=>null),this._rasterJobHandler.connectionPromise}_shutdownJobHandler(){this._rasterJobHandler.instance&&this._rasterJobHandler.instance.destroy(),this._rasterJobHandler.instance=null,this._rasterJobHandler.connectionPromise=null,this._rasterJobHandler.refCount=0,this.raster.rasterJobHandler=null}_configDefaultInterpolation(){if(null==this.interpolation){var e;const t=Object(N.c)(this.rasterInfo,this.raster.tileType,null==(e=this.sourceJSON)?void 0:e.defaultResamplingMethod);this._set("interpolation",t)}}_configDefaultSlice(){const{multidimensionalInfo:e}=this.raster.rasterInfo;if(Object(a.i)(e)){if(!this.multidimensionalDefinition){const t=e.variables[0],r=[];t.dimensions.forEach(e=>{r.push(new D.a({variableName:t.name,dimensionName:e.name,values:e.hasRegularIntervals?e.extent[0]:e.values[0],isSlice:!0}))}),this.multidimensionalDefinition=r}this._sliceId=this.raster.getSliceIndex(this.multidimensionalDefinition)}}_configDefaultRenderer(){const e=this.raster.rasterInfo;var t,r;this.bandIds||(this.bandIds=Object(N.b)(e)),this.renderer||(this.renderer=Object(N.a)(e,{bandIds:this.bandIds,variableName:null==(t=this.multidimensionalDefinition)||null==(r=t[0])?void 0:r.variableName})),this.symbolizer?(this.symbolizer.rendererJSON=Object(N.e)(this.renderer.toJSON()),this.symbolizer.rasterInfo=e):this.symbolizer=new H.a({rendererJSON:this.renderer.toJSON(),rasterInfo:e}),this.symbolizer.bind()||z.warn("imagery-tile-mixin","The given renderer is not supported by the layer.")}};return Object(i.a)([Object(l.b)()],t.prototype,"_cachedRendererJson",void 0),Object(i.a)([Object(l.b)()],t.prototype,"_sliceId",void 0),Object(i.a)([Object(l.b)()],t.prototype,"_compatibleFullExtent",void 0),Object(i.a)([Object(l.b)()],t.prototype,"_rasterJobHandler",void 0),Object(i.a)([Object(l.b)()],t.prototype,"bandIds",void 0),Object(i.a)([Object(l.b)()],t.prototype,"copyright",void 0),Object(i.a)([Object(l.b)({type:M.a}),Object(R.a)("rasterInfo.extent")],t.prototype,"fullExtent",void 0),Object(i.a)([Object(l.b)()],t.prototype,"interpolation",void 0),Object(i.a)([Object(l.b)()],t.prototype,"ioConfig",void 0),Object(i.a)([Object(l.b)({type:[D.a]})],t.prototype,"multidimensionalDefinition",null),Object(i.a)([Object(l.b)()],t.prototype,"raster",void 0),Object(i.a)([Object(l.b)({readOnly:!0}),Object(R.a)("raster.rasterInfo")],t.prototype,"rasterInfo",void 0),Object(i.a)([Object(l.b)()],t.prototype,"sourceJSON",void 0),Object(i.a)([Object(l.b)({type:_.a}),Object(R.a)("rasterInfo.spatialReference")],t.prototype,"spatialReference",void 0),Object(i.a)([Object(l.b)({type:P.a}),Object(R.a)("rasterInfo.storageInfo.tileInfo")],t.prototype,"tileInfo",void 0),Object(i.a)([Object(l.b)(g.n)],t.prototype,"url",null),Object(i.a)([Object(l.b)({types:O.a})],t.prototype,"renderer",null),Object(i.a)([Object(l.b)()],t.prototype,"symbolizer",void 0),t=Object(i.a)([Object(d.a)("esri.layers.ImageryTileMixin")],t),t};var E=r("SuVq"),J=r("8prj"),A=r("pPNP"),q=r("ag7Y");let U=class extends q.a{constructor(){super(...arguments),this.blockWidth=void 0,this.blockHeight=void 0,this.compression=null,this.origin=null,this.firstPyramidLevel=null,this.maximumPyramidLevel=null,this.pyramidScalingFactor=2,this.pyramidBlockWidth=null,this.pyramidBlockHeight=null,this.isVirtualTileInfo=!1,this.tileInfo=null,this.blockBoundary=null}};Object(i.a)([Object(l.b)({type:Number,json:{write:!0}})],U.prototype,"blockWidth",void 0),Object(i.a)([Object(l.b)({type:Number,json:{write:!0}})],U.prototype,"blockHeight",void 0),Object(i.a)([Object(l.b)({type:String,json:{write:!0}})],U.prototype,"compression",void 0),Object(i.a)([Object(l.b)({type:E.a,json:{write:!0}})],U.prototype,"origin",void 0),Object(i.a)([Object(l.b)({type:Number,json:{write:!0}})],U.prototype,"firstPyramidLevel",void 0),Object(i.a)([Object(l.b)({type:Number,json:{write:!0}})],U.prototype,"maximumPyramidLevel",void 0),Object(i.a)([Object(l.b)()],U.prototype,"pyramidScalingFactor",void 0),Object(i.a)([Object(l.b)({type:Number,json:{write:!0}})],U.prototype,"pyramidBlockWidth",void 0),Object(i.a)([Object(l.b)({type:Number,json:{write:!0}})],U.prototype,"pyramidBlockHeight",void 0),Object(i.a)([Object(l.b)({type:Boolean,json:{write:!0}})],U.prototype,"isVirtualTileInfo",void 0),Object(i.a)([Object(l.b)({json:{write:!0}})],U.prototype,"tileInfo",void 0),Object(i.a)([Object(l.b)()],U.prototype,"blockBoundary",void 0),U=Object(i.a)([Object(d.a)("esri.layers.support.RasterStorageInfo")],U);var W=U,G=r("9MzC"),V=r("+rMe"),$=r("FFFX"),Y=r("ne7T"),X=r("tODX"),K=r("IYxN");let Z=class extends(Object(V.b)(q.a)){constructor(){super(...arguments),this.rasterJobHandler=null,this.datasetName=null,this.datasetFormat=null,this.rasterInfo=null,this.ioConfig={sampling:"closest"}}init(){var e=this;return Object(n.a)(function*(){const t=Object(X.d)();e.addResolvingPromise(t),yield e.when()})()}normalizeCtorArgs(e){return e&&e.ioConfig&&(e={...e,ioConfig:{resolution:null,bandIds:null,sampling:"closest",tileInfo:P.a.create(),...e.ioConfig}}),e}set url(e){this._set("url",Object(F.g)(e,o.a.getLogger(this.declaredClass)))}open(e){return Object(n.a)(function*(){throw new p.a("BaseRaster:open-not-implemented","open() is not implemented")})()}fetchTile(e,t,r,i={}){var o=this;return Object(n.a)(function*(){var n;const{tileInfo:s}=i,l=s.lodAt(e),c=o.getTileExtent({x:l.resolution,y:l.resolution},t,r,s.origin,s.spatialReference,s.size);return null!=(n=i.multidimensionalDefinition)&&n.length&&Object(a.i)(o.rasterInfo.multidimensionalInfo)&&null==i.sliceId&&(i={...i,sliceId:o.getSliceIndex(i.multidimensionalDefinition)||0}),o.fetchPixels(c,s.size[0],s.size[1],i)})()}identify(e,t={}){var r=this;return Object(n.a)(function*(){const{spatialReference:n,extent:i}=r.rasterInfo,{datumTransformation:o}=t;let s=Object(X.f)(e,n,o);if(!i.intersects(s))return{location:s,value:null};if(Object(a.i)(r.rasterInfo.transform)){const e=r.rasterInfo.transform.inverseTransform(s);if(!r.rasterInfo.nativeExtent.intersects(e))return{location:e,value:null};s=e}let l=0;if(t.srcResolution)l=Object(X.h)(t.srcResolution,r.rasterInfo,r.ioConfig.sampling).pyramidLevel;else if(l=yield r.computeBestPyramidLevelForLocation(e,t),null==l)return{location:s,value:null};const c=r.identifyPixelLocation(s,l,null);if(null===c)return{location:s,value:null};const{row:u,col:f,rowOffset:d,colOffset:p}=c,m=Object(K.d)(r.url,t.sliceId),h=`${l}/${u}/${f}`;let y=Object(K.c)(m,null,h);Object(a.i)(y)||(y=r.fetchRawTile(l,u,f,t),Object(K.e)(m,null,h,y));const b=yield y;if(!(b&&b.pixels&&b.pixels.length>0))return{location:s,value:null};const g=d*r.rasterInfo.storageInfo.blockHeight+p;return{location:s,value:!b.mask||b.mask[g]?b.pixels.map(e=>e[g]):null,pyramidLevel:l}})()}fetchPixels(e,t,r,i={}){var o=this;return Object(n.a)(function*(){const n=e.clone().normalize(),s=o.rasterInfo.spatialReference,l=!(e=n[0]).spatialReference.equals(s),{datumTransformation:c}=i,u=new E.a({x:(e.xmax-e.xmin)/t,y:(e.ymax-e.ymin)/r,spatialReference:e.spatialReference}),f=i.srcResolution||(l?Object(X.g)(u,s,e,c):u);if(!f)return null;const{pyramidLevel:d,pyramidResolution:p,excessiveReading:m}=Object(X.h)(f,o.rasterInfo,o.ioConfig.sampling);if(m)return null;const h=o.rasterInfo.storageInfo;let y=l?Object(X.e)(e,s,c):e;const b=Object(a.o)(o.rasterInfo.transform);if(b&&(y=b.inverseTransform(y)),null==y)return null;const g={x:Math.floor((y.xmin-h.origin.x)/p.x+.1),y:Math.floor((h.origin.y-y.ymax)/p.y+.1)},x=Math.ceil((y.xmax-y.xmin)/p.x-.1),O=Math.ceil((y.ymax-y.ymin)/p.y-.1);if(x/t>8||O/r>8)return null;const v=yield o.fetchRawPixels(d,g,{width:x,height:O},i);if(!v)return null;if(!l&&1===v.pixelBlocks.length&&(d>0?h.pyramidBlockWidth:h.blockWidth)===t&&(d>0?h.pyramidBlockHeight:h.blockHeight)===r&&f.x===u.x&&f.y===u.y)return{extent:e,srcExtent:y,pixelBlock:v.pixelBlocks[0]};const I=Object(X.c)(e,v.extent,u,c,b);let j;const w=!i.requestRawData,S={rows:I.spacing[0],cols:I.spacing[1]},{pixelBlocks:T,mosaicSize:R,isPartiallyFilled:C}=v;if(o.rasterJobHandler)j=yield o.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:T,srcMosaicSize:R,destDimension:w?{width:t,height:r}:null,coefs:w?I.coefficients:null,sampleSpacing:w?S:null,interpolation:i.interpolation},i);else{const e=Object(Y.j)(T,R);j=w?Object(Y.a)(e,{width:t,height:r},I.coefficients,S,i.interpolation):e}return i.requestRawData?{srcExtent:y,pixelBlock:j,transformGrid:I,extent:e,isPartiallyFilled:C}:{srcExtent:y,extent:e,pixelBlock:j}})()}fetchRawPixels(e,t,r,i){var a=this;return Object(n.a)(function*(){const{origin:n,blockBoundary:o}=a.rasterInfo.storageInfo,{blockWidth:s,blockHeight:l}=a.getBlockWidthHeight(e);let{x:c,y:u}=t,{width:f,height:d}=r;i.buffer&&(c-=i.buffer.cols,u-=i.buffer.rows,f+=2*i.buffer.cols,d+=2*i.buffer.rows);const p=Math.floor(c/s),m=Math.floor(u/l),h=Math.floor((c+f-1)/s),y=Math.floor((u+d-1)/l),b=o[e];if(!b)return null;const{minRow:g,minCol:x,maxCol:O,maxRow:v}=b;if(y<g||h<x||m>v||p>O)return null;const I=[];let j,w=!1;for(let t=m;t<=y;t++)for(let r=p;r<=h;r++)t>=g&&r>=x&&v>=t&&O>=r?(j=a._fetchRawTile(e,t,r,i),a.ioConfig.allowPartialFill&&(j=new Promise(e=>{j.then(t=>e(t)).catch(()=>{w=!0,e(null)})})),I.push(j)):I.push(null);if(0===I.length)return null;const S=yield Promise.all(I),T={height:(y-m+1)*s,width:(h-p+1)*l},{nativePixelSize:R,spatialReference:C}=a.rasterInfo,_=R.x*2**e,k=R.y*2**e;return{extent:new M.a({xmin:n.x+p*s*_,xmax:n.x+(h+1)*s*_,ymin:n.y-(y+1)*l*k,ymax:n.y-m*l*k,spatialReference:C}),pixelBlocks:S,mosaicSize:T,isPartiallyFilled:w}})()}fetchRawTile(e,t,r,i){return Object(n.a)(function*(){throw new p.a("BaseRaster:read-not-implemented","fetchRawTile() is not implemented")})()}computeExtent(e){return Object(X.e)(this.rasterInfo.extent,e)}decodePixelBlock(e,t){return!this.rasterJobHandler||t.useCanvas?Object($.a)(e,t):this.rasterJobHandler.decode({data:e,options:t})}request(e,t,r){var i=this;return Object(n.a)(function*(){var n,a;const{customFetchParameters:o}=i.ioConfig,{range:s,query:l,headers:c}=t;r=null!=(n=null!=(a=r)?a:t.retryCount)?n:i.ioConfig.retryCount;const u=s?{Range:`bytes=${s.from}-${s.to}`}:null;try{return yield Object(k.default)(e,{...t,query:{...l,...o},headers:{...c,...u}})}catch(f){if(r>0)return r--,i.request(e,t,r);throw f}})()}getSliceIndex(e){const{multidimensionalInfo:t}=this.rasterInfo;if(!Object(a.i)(t)||null==e||!e.length)return null;let r=0;const n=e[0].variableName;for(let i=0;i<t.variables.length;i++){const a=t.variables[i],o=a.dimensions;if(a.name!==n){r+=o.map(e=>this._getDimensionValuesCount(e)).reduce((e,t)=>e+t);break}const s=o.map(e=>this._getDimensionValuesCount(e)),l=o.length;for(let t=0;t<l;t++){const n=e.filter(e=>e.dimensionName===o[t].name)[0];if(null==n)return null;const i=Array.isArray(n.values[0])?n.values[0][0]:n.values[0],a=this._getIndexFromDimensions(i,o[t]);if(-1===a)return null;s.shift(),r+=t===l-1?a:a*s.reduce((e,t)=>e+t)}}return r}updateTileInfo(){const{storageInfo:e,spatialReference:t,extent:r,pixelSize:n}=this.rasterInfo;if(!e.tileInfo){const i=[],a=e.maximumPyramidLevel||0;let o=Math.max(n.x,n.y),s=1/.0254*96*o;for(let e=0;e<=a;e++)i.push({level:a-e,resolution:o,scale:s}),o*=2,s*=2;const l=new E.a({x:r.xmin,y:r.ymax,spatialReference:t});e.tileInfo=new P.a({origin:l,size:[e.blockWidth,e.blockHeight],spatialReference:t,lods:i}),e.isVirtualTileInfo=!0}}createRemoteDatasetStorageInfo(e,t=512,r=512,n){const{width:i,height:a,nativeExtent:o,pixelSize:s,spatialReference:l}=e,c=new E.a({x:o.xmin,y:o.ymax,spatialReference:l});null==n&&(n=Math.max(0,Math.round(Math.log(Math.max(i,a))/Math.LN2-8)));const u=this._computeBlockBoundary(o,s,n,512,512);e.storageInfo=new W({blockWidth:t,blockHeight:r,pyramidBlockWidth:t,pyramidBlockHeight:r,origin:c,firstPyramidLevel:1,maximumPyramidLevel:n,blockBoundary:u})}computeBestPyramidLevelForLocation(e,t={}){return Object(n.a)(function*(){return 0})()}identifyPixelLocation(e,t,r){const{spatialReference:n,nativePixelSize:i,nativeExtent:a}=this.rasterInfo,{blockWidth:o,blockHeight:s,maximumPyramidLevel:l,pyramidScalingFactor:c,origin:u}=this.rasterInfo.storageInfo,f=Object(X.f)(e,n,r);if(!a.intersects(f))return null;if(t<0||t>l)return null;const d=c**t,p=(u.y-f.y)/(d*i.y)/s,m=(f.x-u.x)/(d*i.x)/o,h=Math.min(s-1,Math.floor((p-Math.floor(p))*s)),y=Math.min(o-1,Math.floor((m-Math.floor(m))*o));return{pyramidLevel:t,row:Math.floor(p),col:Math.floor(m),rowOffset:h,colOffset:y,srcLocation:f}}getTileExtent(e,t,r,n,i,a){const[o,s]=a,l=n.x+r*o*e.x,c=n.y-t*s*e.y;return new M.a({xmin:l,xmax:l+o*e.x,ymin:c-s*e.y,ymax:c,spatialReference:i})}getBlockWidthHeight(e){return{blockWidth:e>0?this.rasterInfo.storageInfo.pyramidBlockWidth:this.rasterInfo.storageInfo.blockWidth,blockHeight:e>0?this.rasterInfo.storageInfo.pyramidBlockHeight:this.rasterInfo.storageInfo.blockHeight}}isBlockOutside(e,t,r){const n=this.rasterInfo.storageInfo.blockBoundary[e];return!n||n.maxRow<t||n.maxCol<r||n.minRow>t||n.minCol>r}_computeBlockBoundary(e,t,r,n,i){let{x:a,y:o}=t;const s=e.xmin,l=e.ymax,c=[{minCol:Math.floor((e.xmin-s+.1*a)/n/a),maxCol:Math.floor((e.xmax-s-.1*a)/n/a),minRow:Math.floor((l-e.ymax+.1*o)/i/o),maxRow:Math.floor((l-e.ymin-.1*o)/i/o)}];if(r>0)for(let u=0;u<r;u++)a*=2,o*=2,c.push({minCol:Math.floor((e.xmin-s+.1*a)/n/a),maxCol:Math.floor((e.xmax-s-.1*a)/n/a),minRow:Math.floor((l-e.ymax+.1*o)/i/a),maxRow:Math.floor((l-e.ymin-.1*o)/i/a)});return c}_fetchRawTile(e,t,r,n){const i=this.rasterInfo.storageInfo.blockBoundary[e];if(!i)return Promise.resolve(null);const{minRow:o,minCol:s,maxCol:l,maxRow:c}=i;if(t<o||r<s||t>c||r>l)return Promise.resolve(null);const u=Object(K.d)(this.url,n.sliceId),f=`${e}/${t}/${r}`;let d=Object(K.c)(u,n.registryId,f);if(!Object(a.i)(d)){const i=Object(G.d)();d=this.fetchRawTile(e,t,r,{...n,signal:i.signal}),Object(K.e)(u,n.registryId,f,d,i),d.catch(()=>{Object(K.b)(u,n.registryId,f)})}return n.signal&&Object(G.p)(n,()=>{Object(K.a)(u,n.registryId,f)}),d}_getIndexFromDimensions(e,t){const{extent:r,interval:n,unit:i,values:a}=t;if(null!=a&&a.length)return Array.isArray(a[0])?a.findIndex(t=>t[0]<=e&&t[1]>=e):a.indexOf(e);if(e>r[1])return-1;const o=r[0];let s=-1;if("ISO8601"===i){var l;switch((null==(l=t.intervalUnit)?void 0:l.toLowerCase())||"seconds"){case"seconds":s=Math.round((e-o)/1e3/n);break;case"minutes":s=Math.round((e-o)/6e4/n);break;case"hours":s=Math.round((e-o)/36e5/n);break;case"days":s=Math.round((e-o)/864e5/n);break;case"years":s=Math.round((new Date(e).getUTCFullYear()-new Date(o).getUTCFullYear())/n);break;case"decades":s=Math.round((new Date(e).getUTCFullYear()-new Date(o).getUTCFullYear())/10/n)}return s}return Math.round((e-o)/n)}_getDimensionValuesCount(e){const{extent:t,interval:r,unit:n,values:i}=e;let a=(null==i?void 0:i.length)||0;if(a)return a;const o=t[0];if(0===a&&"ISO8601"===n){var s;switch((null==(s=e.intervalUnit)?void 0:s.toLowerCase())||"seconds"){case"seconds":a=Math.round((t[1]-t[0])/1e3/r);break;case"minutes":a=Math.round((t[1]-t[0])/6e4/r);break;case"hours":a=Math.round((t[1]-t[0])/36e5/r);break;case"days":a=Math.round((t[1]-t[0])/864e5/r);break;case"years":a=Math.round((new Date(t[1]).getUTCFullYear()-new Date(o).getUTCFullYear())/r);break;case"decades":a=Math.round((new Date(t[1]).getUTCFullYear()-new Date(o).getUTCFullYear())/10/r)}return a}return Math.round((t[1]-t[0])/r)}};Object(i.a)([Object(l.b)(g.n)],Z.prototype,"url",null),Object(i.a)([Object(l.b)({type:String,json:{write:!0}})],Z.prototype,"datasetName",void 0),Object(i.a)([Object(l.b)({type:String,json:{write:!0}})],Z.prototype,"datasetFormat",void 0),Object(i.a)([Object(l.b)()],Z.prototype,"rasterInfo",void 0),Object(i.a)([Object(l.b)()],Z.prototype,"ioConfig",void 0),Object(i.a)([Object(l.b)()],Z.prototype,"sourceJSON",void 0),Z=Object(i.a)([Object(d.a)("esri.layers.support.rasterDatasets.BaseRaster")],Z);var Q=Z,ee=r("dCrW");function te(e){const t=e.fields,r=e.records,n=t.some(e=>"oid"===e.name.toLowerCase())?"OBJECTID":"OID",i=[{name:n,type:"esriFieldTypeOID",alias:"OID"}].concat(t.map(e=>({name:e.name,type:"esriFieldType"+e.typeName,alias:e.name}))),a=i.map(e=>e.name),o=[];let s=0,l=0;return r.forEach(e=>{const t={};for(t[n]=s++,l=1;l<a.length;l++)t[a[l]]=e[l-1];o.push({attributes:t})}),{displayFieldName:"",fields:i,features:o}}let re=class extends q.a{constructor(){super(...arguments),this.type="identity"}forwardTransform(e){return e}inverseTransform(e){return e}};Object(i.a)([Object(l.b)({json:{write:!0}})],re.prototype,"spatialReference",void 0),Object(i.a)([Object(u.a)({IdentityXform:"identity"})],re.prototype,"type",void 0),re=Object(i.a)([Object(d.a)("esri.layers.support.rasterTransforms.IdentityTransform")],re);var ne=re,ie=r("Cduq");function ae(e,t,r){const{x:n,y:i}=t;if(r<2)return{x:e[0]+n*e[2]+i*e[4],y:e[1]+n*e[3]+i*e[5]};if(2===r){const t=n*n,r=i*i,a=n*i;return{x:e[0]+n*e[2]+i*e[4]+t*e[6]+a*e[8]+r*e[10],y:e[1]+n*e[3]+i*e[5]+t*e[7]+a*e[9]+r*e[11]}}const a=n*n,o=i*i,s=n*i,l=a*n,c=a*i,u=n*o,f=i*o;return{x:e[0]+n*e[2]+i*e[4]+a*e[6]+s*e[8]+o*e[10]+l*e[12]+c*e[14]+u*e[16]+f*e[18],y:e[1]+n*e[3]+i*e[5]+a*e[7]+s*e[9]+o*e[11]+l*e[13]+c*e[15]+u*e[17]+f*e[19]}}function oe(e,t,r){const{xmin:n,ymin:i,xmax:a,ymax:o,spatialReference:s}=t;let l=[];if(r<2)l.push({x:n,y:o}),l.push({x:a,y:o}),l.push({x:n,y:i}),l.push({x:a,y:i});else{let e=10;for(let t=0;t<e;t++)l.push({x:n,y:i+(o-i)*t/(e-1)}),l.push({x:a,y:i+(o-i)*t/(e-1)});e=8;for(let t=1;t<=e;t++)l.push({x:n+(a-n)*t/e,y:i}),l.push({x:n+(a-n)*t/e,y:o})}l=l.map(t=>ae(e,t,r));const c=l.map(e=>e.x),u=l.map(e=>e.y);return new M.a({xmin:Math.min.apply(null,c),xmax:Math.max.apply(null,c),ymin:Math.min.apply(null,u),ymax:Math.max.apply(null,u),spatialReference:s})}let se=class extends q.a{constructor(){super(...arguments),this.polynomialOrder=1,this.type="polynomial"}readForwardCoefficients(e,t){const{coeffX:r,coeffY:n}=t;if(null==r||!r.length||null==n||!n.length||r.length!==n.length)return null;const i=[];for(let a=0;a<r.length;a++)i.push(r[a]),i.push(n[a]);return i}writeForwardCoefficients(e,t,r){const n=[],i=[];for(let a=0;a<(null==e?void 0:e.length);a++)a%2==0?n.push(e[a]):i.push(e[a]);t.coeffX=n,t.coeffY=i}get inverseCoefficients(){let e=this._get("inverseCoefficients");const t=this._get("forwardCoefficients");return!e&&t&&this.polynomialOrder<2&&(e=function(e){const[t,r,n,i,a,o]=e,s=n*o-a*i,l=a*i-n*o;return[(a*r-t*o)/s,(n*r-t*i)/l,o/s,i/l,-a/s,-n/l]}(t)),e}set inverseCoefficients(e){this._set("inverseCoefficients",e)}readInverseCoefficients(e,t){const{inverseCoeffX:r,inverseCoeffY:n}=t;if(null==r||!r.length||null==n||!n.length||r.length!==n.length)return null;const i=[];for(let a=0;a<r.length;a++)i.push(r[a]),i.push(n[a]);return i}writeInverseCoefficients(e,t,r){const n=[],i=[];for(let a=0;a<(null==e?void 0:e.length);a++)a%2==0?n.push(e[a]):i.push(e[a]);t.inverseCoeffX=n,t.inverseCoeffY=i}forwardTransform(e){if("point"===e.type){const t=ae(this.forwardCoefficients,e,this.polynomialOrder);return new E.a({x:t.x,y:t.y,spatialReference:e.spatialReference})}return oe(this.forwardCoefficients,e,this.polynomialOrder)}inverseTransform(e){if("point"===e.type){const t=ae(this.inverseCoefficients,e,this.polynomialOrder);return new E.a({x:t.x,y:t.y,spatialReference:e.spatialReference})}return oe(this.inverseCoefficients,e,this.polynomialOrder)}};Object(i.a)([Object(l.b)({json:{write:!0}})],se.prototype,"polynomialOrder",void 0),Object(i.a)([Object(l.b)()],se.prototype,"forwardCoefficients",void 0),Object(i.a)([Object(f.a)("forwardCoefficients",["coeffX","coeffY"])],se.prototype,"readForwardCoefficients",null),Object(i.a)([Object(ie.a)("forwardCoefficients")],se.prototype,"writeForwardCoefficients",null),Object(i.a)([Object(l.b)({json:{write:!0}})],se.prototype,"inverseCoefficients",null),Object(i.a)([Object(f.a)("inverseCoefficients",["inverseCoeffX","inverseCoeffY"])],se.prototype,"readInverseCoefficients",null),Object(i.a)([Object(ie.a)("inverseCoefficients")],se.prototype,"writeInverseCoefficients",null),Object(i.a)([Object(l.b)({json:{write:!0}})],se.prototype,"spatialReference",void 0),Object(i.a)([Object(u.a)({PolynomialXform:"polynomial"})],se.prototype,"type",void 0),se=Object(i.a)([Object(d.a)("esri.layers.support.rasterTransforms.PolynomialTransform")],se);var le=se;const ce={PolynomialXform:le,IdentityXform:ne},ue=Object.keys(ce),fe=new Map;fe.set("int16","esriFieldTypeSmallInteger"),fe.set("int32","esriFieldTypeInteger"),fe.set("int64","esriFieldTypeInteger"),fe.set("float32","esriFieldTypeSingle"),fe.set("float64","esriFieldTypeDouble"),fe.set("text","esriFieldTypeString");let de=class extends Q{constructor(){super(...arguments),this.storageInfo=null,this.datasetFormat="CRF"}open(e){var t=this;return Object(n.a)(function*(){yield t.init();const{data:r}=yield t.request(t.url+"/conf.json",{signal:null==e?void 0:e.signal});if(!t._validateHeader(r))throw new p.a("cloudraster:open","Invalid or unsupported conf.json.");t.datasetName=t.url.slice(t.url.lastIndexOf("/")+1);const{storageInfo:n,rasterInfo:i}=t._parseHeader(r);if("thematic"===i.dataType){const e=yield t._fetchAuxiliaryInformation();i.attributeTable=e}t._set("storageInfo",n),t._set("rasterInfo",i),t.ioConfig.retryCount=t.ioConfig.retryCount||0})()}fetchRawTile(e,t,r,i={}){var a=this;return Object(n.a)(function*(){const n=a.rasterInfo.storageInfo.maximumPyramidLevel-e;if(n<0)return null;const o=a._buildCacheFilePath(n,t,r,i.multidimensionalDefinition),s=a._getIndexRecordFromBundle(t,r),l=yield a.request(o,{range:{from:0,to:a.storageInfo.headerSize-1},responseType:"array-buffer",signal:i.signal});if(!l)return null;const c=new Uint8Array(l.data),u=a._getTileEndAndContentType(c,s);if(0===u.recordSize)return null;const f=yield a.request(o,{range:{from:u.position,to:u.position+u.recordSize},responseType:"array-buffer",signal:i.signal});return f?a.decodePixelBlock(f.data,{width:a.rasterInfo.storageInfo.tileInfo.size[0],height:a.rasterInfo.storageInfo.tileInfo.size[1],planes:null,pixelType:null}):null})()}_validateHeader(e){return e&&"RasterInfo"===e.type&&!["origin","extent","geodataXform","LODInfos","blockWidth","blockHeight","bandCount","pixelType","pixelSizeX","pixelSizeY","format","packetSize"].some(t=>!e[t])}_parseHeader(e){var t,r;const n=["u1","u2","u4","u8","s8","u16","s16","u32","s32","f32","f64"][e.pixelType],{bandCount:i,histograms:a,colormap:o,blockWidth:s,blockHeight:l,firstPyramidLevel:c,maximumPyramidLevel:u}=e,f=e.statistics&&e.statistics.map(e=>({min:e.min,max:e.max,avg:e.mean,stddev:e.standardDeviation,median:e.median,mode:e.mode})),d=e.extent.spatialReference,p=null==(t=e.geodataXform)?void 0:t.spatialReference,m=new _.a(null!=d&&d.wkid||null!=d&&d.wkt?d:p);let h=new M.a({xmin:e.extent.xmin,ymin:e.extent.ymin,xmax:e.extent.xmax,ymax:e.extent.ymax,spatialReference:m});const y=new E.a({x:e.pixelSizeX,y:e.pixelSizeY,spatialReference:m}),b=Math.round((h.xmax-h.xmin)/y.x),g=Math.round((h.ymax-h.ymin)/y.y),x=this._parseTransform(e.geodataXform),O=x?h:null;x&&(h=x.forwardTransform(h),y.x=(h.xmax-h.xmin)/b,y.y=(h.ymax-h.ymin)/g);const v=null!=(r=e.properties)?r:{},I=e.format.toLowerCase().replace("cache/",""),j=new E.a(e.origin.x,e.origin.y,m);let w,S,T,R;if(o&&o.colors)for(w=[],S=0;S<o.colors.length;S++)T=o.colors[S],R=o.values?o.values[S]:S,w.push([R,255&T,T<<16>>>24,T<<8>>>24,T>>>24]);const C=e.LODInfos,k=[];for(S=0;S<C.levels.length;S++)k.push({level:C.levels[S],resolution:C.resolutions[S],scale:96/.0254*C.resolutions[S]});const F=new P.a({dpi:96,lods:k,format:I,origin:j,size:[s,l],spatialReference:m}),D={recordSize:8,packetSize:e.packetSize,headerSize:e.packetSize*e.packetSize*8+64},B=[{maxCol:Math.ceil(b/s)-1,maxRow:Math.ceil(g/l)-1,minCol:0,minRow:0}];let N=2;if(u>0)for(S=0;S<u;S++)B.push({maxCol:Math.ceil(b/N/s)-1,maxRow:Math.ceil(g/N/l)-1,minCol:0,minRow:0}),N*=2;return{storageInfo:D,rasterInfo:new A.a({width:b,height:g,pixelType:n,bandCount:i,extent:h,nativeExtent:O,transform:x,spatialReference:m,pixelSize:y,keyProperties:v,statistics:f,histograms:a,multidimensionalInfo:e.mdInfo,colormap:w,storageInfo:new W({blockWidth:s,blockHeight:l,pyramidBlockWidth:s,pyramidBlockHeight:l,origin:j,tileInfo:F,firstPyramidLevel:c,maximumPyramidLevel:u,blockBoundary:B})})}}_parseTransform(e){var t,r,n;if((n=e)&&!ue.includes(null==n?void 0:n.type))throw new p.a("cloudraster:open","the data contains unsupported geodata transform types");const i=function(e){if(!(null==e?void 0:e.type))return null;const t=ce[null==e?void 0:e.type];if(t){const r=new t;return r.read(e),r}return null}(e);if("identity"===i.type)return null;if(null==(t=i.forwardCoefficients)||!t.length||null==(r=i.inverseCoefficients)||!r.length)throw new p.a("cloudraster:open","the data contains unsupported geodata transforms - both forward and inverse coefficients are required currently");return i}_fetchAuxiliaryInformation(e){var t=this;return Object(n.a)(function*(){const r=t.request(t.url+"/conf.vat.json",{signal:e}).then(e=>e.data).catch(()=>null),n=t.request(t.url+"/conf.vat.dbf",{responseType:"array-buffer",signal:e}).then(e=>e.data).catch(()=>null),i=yield Promise.all([r,n]);let a;if(i[0]){let e=i[0].fields;const t=i[0].values;if(e&&t){e=e.map(e=>({type:"OID"===e.name?"esriFieldTypeOID":fe.get(e.type),name:e.name,alias:e.alias||e.name}));const r=t.map(e=>({attributes:e}));e&&t&&(a={fields:e,features:r})}}return!a&&i[1]&&(a=class{static get supportedVersions(){return[5]}static parse(e){const t=new DataView(e),r=3&t.getUint8(0);if(3!==r)return{header:{version:r},recordSet:null};const n=t.getUint32(4,!0),i=t.getUint16(8,!0),a=t.getUint16(10,!0),o={version:r,recordCount:n,headerByteCount:i,recordByteCount:a};let s=32;const l=[],c=[];let u;if(3===r){for(;13!==t.getUint8(s);)u=String.fromCharCode(t.getUint8(s+11)).trim(),l.push({name:Object(ee.a)(new Uint8Array(e,s,11)),type:u,typeName:["String","Date","Double","Boolean","String","Integer"][["C","D","F","L","M","N"].indexOf(u)],length:t.getUint8(s+16)}),s+=32;if(s+=1,l.length>0)for(;c.length<n&&e.byteLength-s>a;){const r=[];32===t.getUint8(s)?(s+=1,l.forEach(t=>{if("C"===t.type)r.push(Object(ee.a)(new Uint8Array(e,s,t.length)).trim());else if("N"===t.type)r.push(parseInt(String.fromCharCode.apply(null,new Uint8Array(e,s,t.length)).trim(),10));else if("F"===t.type)r.push(parseFloat(String.fromCharCode.apply(null,new Uint8Array(e,s,t.length)).trim()));else if("D"===t.type){const n=String.fromCharCode.apply(null,new Uint8Array(e,s,t.length)).trim();r.push(new Date(parseInt(n.substring(0,4),10),parseInt(n.substring(4,6),10)-1,parseInt(n.substring(6,8),10)))}s+=t.length}),c.push(r)):s+=a}}return{header:o,fields:l,records:c,recordSet:te({fields:l,records:c})}}}.parse(i[1]).recordSet),J.default.fromJSON(a)})()}_buildCacheFilePath(e,t,r,n){const i=this.storageInfo.packetSize,o=Math.floor(t/i)*i,s=Math.floor(r/i)*i,l="R"+this._toHexString4(o)+"C"+this._toHexString4(s);let c="L";c+=e>=10?e.toString():"0"+e.toString();const{multidimensionalInfo:u}=this.rasterInfo,f=null==n?void 0:n[0];if(!Object(a.i)(u)||!f)return`${this.url}/_alllayers/${c}/${l}.bundle`;let d=u.variables.filter(e=>e.name===f.variableName)[0].dimensions[0].values.indexOf(f.values[0]).toString(16);const p=4-d.length;for(let a=0;a<p;a++)d="0"+d;return d="S"+d,`${this.url}/_alllayers/${f.variableName}/${d}/${c}/${l}.bundle`}_getIndexRecordFromBundle(e,t){const r=this.storageInfo.packetSize,n=r*(e%r)+t%r;if(n<0)throw"Invalid level / row / col";return 20+n*this.storageInfo.recordSize+44}_getTileEndAndContentType(e,t){const r=e.subarray(t,t+8);let n,i=0;for(n=0;n<5;n++)i|=(255&r[n])<<8*n;const a=0xffffffffff&i;for(i=0,n=5;n<8;n++)i|=(255&r[n])<<8*(n-5);return{position:a,recordSize:0xffffffffff&i}}_toHexString4(e){let t=e.toString(16);if(4!==t.length){let e=4-t.length;for(;e-- >0;)t="0"+t}return t}};Object(i.a)([Object(l.b)({readOnly:!0})],de.prototype,"storageInfo",void 0),Object(i.a)([Object(l.b)({type:String,json:{write:!0}})],de.prototype,"datasetFormat",void 0),de=Object(i.a)([Object(d.a)("esri.layers.support.rasterDatasets.CloudRaster")],de);var pe=de;let me=class extends Q{constructor(){super(...arguments),this.datasetFormat="MEMORY"}open(e){var t=this;return Object(n.a)(function*(){var r;yield t.init();const{pixelBlock:n,statistics:i,histograms:a,name:o,keyProperties:s,nativeExtent:l,transform:c}=t.data,{width:u,height:f,pixelType:d}=n,p=t.data.extent||new M.a({xmin:-.5,ymin:.5,xmax:u-.5,ymax:f-.5,spatialReference:new _.a({wkid:3857})}),m=null!=(r=t.data.isPseudoSpatialReference)?r:!t.data.extent,h=new A.a({width:u,height:f,pixelType:d,extent:p,nativeExtent:l,transform:c,pixelSize:{x:p.width/u,y:p.height/f},spatialReference:p.spatialReference,bandCount:3,keyProperties:s||{},statistics:i,isPseudoSpatialReference:m,histograms:a});t.createRemoteDatasetStorageInfo(h,512,512),t._set("rasterInfo",h),t.updateTileInfo(),yield t._buildInMemoryRaster(n,{width:512,height:512},e),t.datasetName=o,t.url="/InMemory/"+o})()}fetchRawTile(e,t,r,n={}){const i=this._pixelBlockTiles.get(`${e}/${t}/${r}`);return Promise.resolve(i)}_buildInMemoryRaster(e,t,r){var i=this;return Object(n.a)(function*(){const n=i.rasterInfo.storageInfo.maximumPyramidLevel,o=i.rasterJobHandler?i.rasterJobHandler.split({pixelBlock:e,tileSize:t,maximumPyramidLevel:n},r):Promise.resolve(Object(Y.n)(e,t,n)),s=Object(a.i)(i.rasterInfo.statistics),l=Object(a.i)(i.rasterInfo.histograms),c=s&&l?Promise.resolve({statistics:null,histograms:null}):i.rasterJobHandler?i.rasterJobHandler.estimateStatisticsHistograms({pixelBlock:e},r):Promise.resolve(Object(Y.g)(e)),u=yield Object(G.j)([o,c]);if(!u[0].value&&u[1].value)throw new p.a("inmemory-raster:open","failed to build in memory raster");var f,d;i._pixelBlockTiles=u[0].value,s||(i.rasterInfo.statistics=null==(f=u[1].value)?void 0:f.statistics),l&&(i.rasterInfo.histograms=null==(d=u[1].value)?void 0:d.histograms)})()}};Object(i.a)([Object(l.b)({type:String,json:{write:!0}})],me.prototype,"datasetFormat",void 0),Object(i.a)([Object(l.b)()],me.prototype,"data",void 0),me=Object(i.a)([Object(d.a)("esri.layers.support.rasterDatasets.InMemoryRaster")],me);var he=me;function ye(e,t){if(!e||!t)return[];let r=t;t.indexOf("/")>-1?(r=t.slice(0,t.indexOf("/")),t=t.slice(t.indexOf("/")+1)):t="";const n=[];if(t){const i=ye(e,r);for(let e=0;e<i.length;e++)ye(i[e],t).forEach(e=>n.push(e));return n}const i=e.getElementsByTagNameNS("*",r);if(!i||0===i.length)return[];for(let a=0;a<i.length;a++)n.push(i[a]||i.item[a]);return n}function be(e,t){if(!e||!t)return null;let r=t;t.indexOf("/")>-1?(r=t.slice(0,t.indexOf("/")),t=t.slice(t.indexOf("/")+1)):t="";const n=ye(e,r);return n.length>0?t?be(n[0],t):n[0]:null}function ge(e,t=null){const r=t?be(e,t):e;let n;return r?(n=r.textContent||r.nodeValue,n?n.trim():null):null}function xe(e,t){return function(e,t){const r=ye(e,t),n=[];let i;for(let a=0;a<r.length;a++)i=r[a].textContent||r[a].nodeValue,i&&(i=i.trim(),""!==i&&n.push(i));return n}(e,t).map(e=>Number(e))}function Oe(e,t){const r=ge(e,t);return Number(r)}function ve(e,t){var r;const n=null==e||null==(r=e.nodeName)?void 0:r.toLowerCase(),i=t.toLowerCase();return n.slice(n.lastIndexOf(":")+1)===i}function Ie(e,t){if(!e||!t)return null;const r=[];for(let n=0;n<e.length;n++)r.push(e[n]),r.push(t[n]);return r}function je(e){if(!e)return null;let t=Number(e);if(!isNaN(t)&&0!==t)return new _.a({wkid:t});if(!(e=String(e)).startsWith("GEOGCS")&&!e.startsWith("PROJCS"))return null;const r=e.replace(/\]/g,"[").replace(/\"/g,"").split("[").map(e=>e.trim()).filter(e=>""!==e),n=r[r.length-1].split(",");return"EPSG"===n[0]&&e.endsWith('"]]')&&(t=Number(n[1]),!isNaN(t)&&0!==t)?new _.a({wkid:t}):new _.a({wkt:e})}function we(e){var t;if("pamdataset"!==(null==e||null==(t=e.documentElement.tagName)?void 0:t.toLowerCase()))return{};const r={spatialReference:null,transform:null,metadata:{},rasterBands:[],statistics:null,histograms:null};e.documentElement.childNodes.forEach(e=>{if(1===e.nodeType)if(ve(e,"SRS")){if(!r.spatialReference){const t=ge(e);r.spatialReference=je(t)}}else if(ve(e,"Metadata"))if("xml:ESRI"===e.getAttribute("domain")){const{spatialReference:t,transform:n}=function(e){var t;const r=be(e,"GeodataXform"),n=je(Oe(r,"SpatialReference/WKID")||ge(r,"SpatialReference/WKT"));if("typens:PolynomialXform"!==r.getAttribute("xsi:type"))return{spatialReference:n,transform:null};const i=null!=(t=Oe(r,"PolynomialOrder"))?t:1,a=xe(r,"CoeffX/Double"),o=xe(r,"CoeffY/Double"),s=xe(r,"InverseCoeffX/Double"),l=xe(r,"InverseCoeffY/Double"),c=Ie(a,o),u=Ie(s,l);return{spatialReference:n,transform:new le({spatialReference:n,polynomialOrder:i,forwardCoefficients:c,inverseCoefficients:u})}}(e);r.transform=n,r.spatialReference||(r.spatialReference=t)}else ye(e,"MDI").forEach(e=>r.metadata[e.getAttribute("key")]=ge(e));else if(ve(e,"PAMRasterBand")){const t=function(e){var t;const r=Oe(e,"NoDataValue"),n=be(e,"Histograms/HistItem"),i=Oe(n,"HistMin"),a=Oe(n,"HistMax"),o=Oe(n,"BucketCount"),s=null==(t=ge(n,"HistCounts"))?void 0:t.split("|").map(e=>Number(e));let l,c,u,f;ye(e,"Metadata/MDI").forEach(e=>{var t;const r=Number(null!=(t=e.textContent)?t:e.nodeValue);switch(e.getAttribute("key").toUpperCase()){case"STATISTICS_MINIMUM":l=r;break;case"STATISTICS_MAXIMUM":c=r;break;case"STATISTICS_MEAN":u=r;break;case"STATISTICS_STDDEV":f=r}});const d=Oe(e,"Metadata/SourceBandIndex");return{noDataValue:r,histogram:null!=s&&s.length&&null!=l&&null!=c?{min:i,max:a,size:o||s.length,counts:s}:null,sourceBandIndex:d,statistics:null!=l&&null!=c?{min:l,max:c,avg:u,stddev:f}:null}}(e);null!=t.sourceBandIndex&&null==r.rasterBands[t.sourceBandIndex]?r.rasterBands[t.sourceBandIndex]=t:r.rasterBands.push(t)}});const n=r.rasterBands;return n&&(r.statistics=n[0].statistics?n.map(e=>e.statistics):null,r.histograms=n[0].histogram?n.map(e=>e.histogram):null),r}let Se=class extends Q{open(e){var t=this;return Object(n.a)(function*(){yield t.init();const r=yield t._fetchData(e);let{spatialReference:n,statistics:i,histograms:a,transform:o}=yield t._fetchAuxiliaryData(e);const s=!n;s&&(n=new _.a({wkid:3857})),null!=a&&a.length&&null==i&&(i=Object(Y.f)(a));const{width:l,height:c}=r;let u=new M.a({xmin:-.5,ymin:.5-c,xmax:l-.5,ymax:.5,spatialReference:n});const f=o?o.forwardTransform(u):u;let d=!0;if(o){const e=o.forwardCoefficients;d=e&&0===e[1]&&0===e[2],d&&(o=null,u=f)}const p=new he({data:{extent:f,nativeExtent:u,transform:o,pixelBlock:r,statistics:i,histograms:a,keyProperties:{DateType:"Processed"},isPseudoSpatialReference:s}});yield p.open(),t._set("rasterInfo",p.rasterInfo),t._inMemoryRaster=p})()}fetchRawTile(e,t,r,n={}){return this._inMemoryRaster.fetchRawTile(e,t,r,n)}_fetchData(e){var t=this;return Object(n.a)(function*(){const{data:r}=yield t.request(t.url,{responseType:"array-buffer",signal:null==e?void 0:e.signal}),n=Object($.b)(r).toUpperCase();if("JPG"!==n&&"PNG"!==n&&"GIF"!==n&&"BMP"!==n)throw new p.a("image-aux-raster:open","the data is not a supported format");return t._set("datasetFormat",n),yield t.decodePixelBlock(r,{format:"jpg",width:1,height:1,useCanvas:!0})})()}_fetchAuxiliaryData(e){var t=this;return Object(n.a)(function*(){var r,n;const i=Object(a.o)(null==e?void 0:e.signal),o=null!=(r=t.ioConfig.skipExtensions)?r:[],s=o.indexOf("aux.xml")>-1?null:t.request(t.url+".aux.xml",{responseType:"xml",signal:i}),l=t.datasetFormat,c="JPG"===l?"jgw":"PNG"===l?"pgw":"BMP"===l?"bpw":null,u=o.indexOf(c)>-1?null:t.request(t.url.slice(0,t.url.lastIndexOf("."))+"."+c,{responseType:"text",signal:i}),f=yield Object(G.j)([s,u]);if(null!=i&&i.aborted)throw Object(G.e)();const d=we(null==(n=f[0].value)?void 0:n.data);if(!d.transform){const e=f[1].value?f[1].value.data.split("\n").slice(0,6).map(e=>Number(e)):null;d.transform=6===(null==e?void 0:e.length)?new le({forwardCoefficients:[e[4],e[5],e[0],-e[1],e[2],-e[3]]}):null}return d})()}};Object(i.a)([Object(l.b)({type:String,json:{write:!0}})],Se.prototype,"datasetFormat",void 0),Se=Object(i.a)([Object(d.a)("esri.layers.support.rasterDatasets.ImageAuxRaster")],Se);var Te=Se,Re=r("q2iW"),Ce=r("llFo");let _e=class extends Q{constructor(){super(...arguments),this._levelOffset=0,this._slices=null,this._tilemapCache=null,this.datasetFormat="RasterTileServer"}open(e){var t=this;return Object(n.a)(function*(){yield t.init();const r=e&&e.signal,n=t.sourceJSON?{data:t.sourceJSON}:yield t.request(t.url,{query:{f:"json"},signal:r});n.ssl&&(t.url=t.url.replace(/^http:/i,"https:"));const i=n.data;if(t.sourceJSON=i,!i)throw new p.a("imageserverraster:open","cannot initialize tiled image service, missing service info");if(!i.tileInfo)throw new p.a("imageserverraster:open","use ImageryLayer to open non-tiled image services");t._fixScaleInServiceInfo(),t.tileType=i.cacheType,null==t.tileType&&(t.tileType=["jpg","jpeg","png","png8","png24","png32","mixed"].indexOf(i.tileInfo.format.toLowerCase())>-1?"Map":"lerc"===i.tileInfo.format.toLowerCase()?"Elevation":"Raster"),t.datasetName=i.name.slice(i.name.indexOf("/")+1);const o=yield t._fetchRasterInfo({signal:r});if(!Object(a.i)(o))throw new p.a("image-server-raster:open","cannot initialize image service");{const e="Map"===t.tileType?Object(Re.a)(i.tileInfo,i):P.a.fromJSON(i.tileInfo),{extent:r,pixelSize:n}=o,a=.5/o.width*n.x;let s,l;const c=e.lodAt(Math.max.apply(null,e.lods.map(e=>e.level)));"Map"!==t.tileType&&0!==i.maxScale&&("Raster"===t.tileType?(s=e.lods.filter(e=>e.resolution===n.x)[0],s||(s=e.lods[e.lods.length-1])):(s=e.lods.filter(e=>Math.abs(e.scale-i.maxScale)<a)[0],s||(s=e.lods.filter(e=>e.scale>i.maxScale).sort((e,t)=>e.scale>t.scale?1:-1)[0])),n.x=n.y=s.resolution,o.width=Math.ceil((r.xmax-r.xmin)/n.x-.1),o.height=Math.ceil((r.ymax-r.ymin)/n.y-.1)),s||(s=c);const u=e.lodAt(Math.min.apply(null,e.lods.map(e=>e.level)));"Map"===t.tileType?t._levelOffset=e.lods[0].level:0!==i.minScale&&"Elevation"===t.tileType&&(l=e.lods.filter(e=>Math.abs(e.scale-i.minScale)<a)[0],t._levelOffset=l.level-u.level),l||(l=u);const f=Math.max(n.x,n.y);(Math.abs(n.x-n.y)>a||!e.lods.some(e=>Math.abs(e.resolution-f)<a))&&(n.x=n.y=s.resolution,o.width=Math.ceil((r.xmax-r.xmin)/n.x-.1),o.height=Math.ceil((r.ymax-r.ymin)/n.y-.1));const d=s.level-l.level,[p,m]=e.size,h=e.origin;let{x:y,y:b}=n;const g=[{minCol:Math.floor((r.xmin-h.x+.1*y)/p/y),maxCol:Math.floor((r.xmax-h.x-.1*y)/p/y),minRow:Math.floor((h.y-r.ymax+.1*b)/m/b),maxRow:Math.floor((h.y-r.ymin-.1*b)/m/b)}];if(d>0)for(let t=0;t<d;t++)y*=2,b*=2,g.push({minCol:Math.floor((r.xmin-h.x+.1*y)/p/y),maxCol:Math.floor((r.xmax-h.x-.1*y)/p/y),minRow:Math.floor((h.y-r.ymax+.1*b)/m/y),maxRow:Math.floor((h.y-r.ymin-.1*b)/m/y)});o.storageInfo=new W({blockWidth:e.size[0],blockHeight:e.size[1],pyramidBlockWidth:e.size[0],pyramidBlockHeight:e.size[1],compression:e.format,origin:e.origin,firstPyramidLevel:1,maximumPyramidLevel:d,tileInfo:e,blockBoundary:g}),t._set("rasterInfo",o)}if(i.capabilities.toLowerCase().indexOf("tilemap")>-1){const e={tileInfo:o.storageInfo.tileInfo,parsedUrl:Object(m.J)(t.url),url:t.url,tileServers:[],type:"tile"};t._tilemapCache=new Ce.a({layer:e})}})()}fetchRawTile(e,t,r,i={}){var a=this;return Object(n.a)(function*(){const{storageInfo:n,extent:o,pixelSize:s}=a.rasterInfo,l=`${a.url}/tile/${n.maximumPyramidLevel-e+a._levelOffset}/${t}/${r}`,c=a._slices?{sliceId:i.sliceId||0}:null,{data:u}=yield a.request(l,{query:c,responseType:"array-buffer",signal:i.signal});if(!u)return null;const f=yield a.decodePixelBlock(u,{width:n.tileInfo.size[0],height:n.tileInfo.size[1],planes:null,pixelType:null,isPoint:"Elevation"===a.tileType}),d=n.blockBoundary[e];if("jpg"!==n.compression||r>d.minCol&&r<d.maxCol&&t>d.minRow&&t<d.maxRow)return f;const{origin:p,blockWidth:m,blockHeight:h}=n,y=2**e,b=Math.round((o.xmin-p.x)/(s.x*y))%m,g=Math.round((o.xmax-p.x)/(s.x*y))%m,x=Math.round((p.y-o.ymax)/(s.x*y))%h,O=Math.round((p.y-o.ymin)/(s.x*y))%h,v=r===d.minCol?b:0,I=t===d.minRow?x:0,j=r===d.maxCol?g:m,w=t===d.maxRow?O:h;return Object(Y.m)(f,{x:v,y:I},{width:j-v,height:w-I}),f})()}getSliceIndex(e){if(null==e||!e.length||!this._slices)return null;const t=e;for(let r=0;r<this._slices.length;r++){const e=this._slices[r].multidimensionalDefinition;if(e.length===t.length&&!e.some(e=>{const r=t.filter(t=>e.variableName===t.variableName&&t.dimensionName===e.dimensionName)[0];return!r||(Array.isArray(e.values[0])?e.values[0][0]:e.values[0])!==(Array.isArray(r.values[0])?r.values[0][0]:r.values[0])}))return r}return null}fetchVariableStatisticsHistograms(e,t){var r=this;return Object(n.a)(function*(){const n=r.request(r.url+"/statistics",{query:{variable:e,f:"json"},signal:t}).then(e=>{var t;return null==(t=e.data)?void 0:t.statistics}),i=r.request(r.url+"/histograms",{query:{variable:e,f:"json"},signal:t}).then(e=>{var t;return null==(t=e.data)?void 0:t.histograms}),a=yield Promise.all([n,i]);return a[0]&&a[0].forEach(e=>{e.avg=e.mean,e.stddev=e.standardDeviation}),{statistics:a[0]||null,histograms:a[1]||null}})()}computeBestPyramidLevelForLocation(e,t={}){var r=this;return Object(n.a)(function*(){if(!r._tilemapCache)return 0;let n=r.identifyPixelLocation(e,0,Object(a.o)(t.datumTransformation));if(null===n)return null;let i=0;const{maximumPyramidLevel:o}=r.rasterInfo.storageInfo;let s=o-i+r._levelOffset;const l=n.srcLocation;for(;s>=0;){try{if("available"===(yield r._tilemapCache.fetchAvailability(s,n.row,n.col,t)))break}catch{}if(s--,i++,n=r.identifyPixelLocation(l,i,Object(a.o)(t.datumTransformation)),null===n)return null}return-1===s||null==n?null:i})()}_fetchRasterInfo(e){var t=this;return Object(n.a)(function*(){const r=t.sourceJSON,n=Math.ceil((r.extent.xmax-r.extent.xmin)/r.pixelSizeX-.1),i=Math.ceil((r.extent.ymax-r.extent.ymin)/r.pixelSizeY-.1),a=_.a.fromJSON(r.spatialReference||r.extent.spatialReference);if("Map"===t.tileType)return new A.a({width:n,height:i,bandCount:3,extent:M.a.fromJSON(r.extent),spatialReference:a,pixelSize:new E.a({x:r.pixelSizeX,y:r.pixelSizeY,spatialReference:a}),pixelType:"u8",statistics:null,keyProperties:{DataType:"processed"}});const{slice:o,signal:s}=e,l=!!r.hasRasterAttributeTable&&t.request(t.url+"/rasterAttributeTable",{query:{slice:o,f:"json"},signal:s}).then(e=>J.default.fromJSON(e.data)).catch(()=>null),c=!!r.hasColormap&&t.request(t.url+"/colormap",{query:{slice:o,f:"json"},signal:s}).then(e=>{var t;return null==(t=e.data)?void 0:t.colormap}),u=!!r.hasHistograms&&t.request(t.url+"/histograms",{query:{slice:o,f:"json"},signal:s}).then(e=>{var t;return null==(t=e.data)?void 0:t.histograms}),f=t.request(t.url+"/keyProperties",{query:{f:"json"},signal:s}).then(e=>e.data).catch(()=>{}),d=!!r.hasMultidimensions&&t._fetchMultidimensionalInfo(),p=!!r.hasMultidimensions&&t.request(t.url+"/slices",{query:{f:"json"},signal:s}).then(e=>e.data&&e.data.slices).catch(()=>{});return Promise.all([l,c,u,f,d,p]).then(e=>{let o=null;if(r.minValues&&r.minValues.length===r.bandCount){o=[];for(let e=0;e<r.minValues.length;e++)o.push({min:r.minValues[e],max:r.maxValues[e],avg:r.meanValues[e],stddev:r.stdvValues[e]})}return t._slices=e[5]||null,new A.a({width:n,height:i,bandCount:r.bandCount,extent:M.a.fromJSON(r.extent),spatialReference:a,pixelSize:new E.a({x:r.pixelSizeX,y:r.pixelSizeY,spatialReference:a}),pixelType:r.pixelType.toLowerCase(),statistics:o,attributeTable:e[0]||null,colormap:e[1]||null,histograms:e[2]||null,keyProperties:e[3]||{},multidimensionalInfo:e[4]||null})})})()}_fetchMultidimensionalInfo(e){var t=this;return Object(n.a)(function*(){var r;const n=yield t.request(t.url+"/multidimensionalInfo",{query:{f:"json"},signal:e}).then(e=>{var t;return null==(t=e.data)?void 0:t.multidimensionalInfo});return null!=(r=n.variables)&&r.length&&n.variables.forEach(e=>{var t;null!=(t=e.statistics)&&t.length&&e.statistics.forEach(e=>{e.avg=e.mean,e.stddev=e.standardDeviation})}),n})()}_fixScaleInServiceInfo(){const{sourceJSON:e}=this;e.minScale&&e.minScale<0&&(e.minScale=0),e.maxScale&&e.maxScale<0&&(e.maxScale=0)}};Object(i.a)([Object(l.b)({type:String,json:{write:!0}})],_e.prototype,"datasetFormat",void 0),Object(i.a)([Object(l.b)()],_e.prototype,"tileType",void 0),_e=Object(i.a)([Object(d.a)("esri.layers.support.rasterDatasets.ImageServerRaster")],_e);var Me=_e,ke=r("Piei"),Fe=r("5VpP");const Pe=new Map;Pe.set("Int8","s8"),Pe.set("UInt8","u8"),Pe.set("Int16","s16"),Pe.set("UInt16","u16"),Pe.set("Int32","s32"),Pe.set("UInt32","u32"),Pe.set("Float32","f32"),Pe.set("Float64","f32"),Pe.set("Double64","f32");const De=new Map;De.set("lerc",".lrc"),De.set("none",".til"),De.set("deflate",".pzp"),De.set("jpeg",".jzp");let Be=class extends Q{constructor(){super(...arguments),this._files=null,this._storageIndex=null,this.datasetFormat="MRF"}open(e){var t=this;return Object(n.a)(function*(){var r;yield t.init(),t.datasetName=t.url.slice(t.url.lastIndexOf("/")+1);const n=e?Object(a.o)(e.signal):null,i=yield t.request(t.url,{responseType:"xml",signal:n}),{rasterInfo:o,files:s}=t._parseHeader(i.data);if(-1===(null==(r=t.ioConfig.skipExtensions)?void 0:r.indexOf("aux.xml"))){const r=yield t._fetchAuxiliaryData(e);var l;null!=r&&(o.statistics=null!=(l=r.statistics)?l:o.statistics,o.histograms=r.histograms,r.histograms&&!Object(a.i)(o.statistics)&&(o.statistics=Object(Y.f)(r.histograms)))}t._set("rasterInfo",o),t._files=s;const c=yield t.request(s.index,{responseType:"array-buffer",signal:n});t._storageIndex=t._parseIndex(c.data);let u,f,d=0,p=-1;const{blockWidth:m,blockHeight:h,compression:y}=t.rasterInfo.storageInfo,b=t.rasterInfo.storageInfo.pyramidScalingFactor,{width:g,height:x,bandCount:O}=t.rasterInfo,v=[],I="none"===y?1:O;for(;d<t._storageIndex.length;)p++,u=Math.ceil(g/m/b**p),f=Math.ceil(x/h/b**p),d+=u*f*I*4,v.push({maxRow:f,maxCol:u,minCol:0,minRow:0});t.rasterInfo.storageInfo.blockBoundary=v,p>0&&(t.rasterInfo.storageInfo.firstPyramidLevel=1,t.rasterInfo.storageInfo.maximumPyramidLevel=p),t.updateTileInfo()})()}fetchRawTile(e,t,r,i={}){var a=this;return Object(n.a)(function*(){const{blockWidth:n,blockHeight:o,blockBoundary:s,compression:l}=a.rasterInfo.storageInfo,c=s[e];if(!c||c.maxRow<t||c.maxCol<r||c.minRow>t||c.minCol>r)return null;const{bandCount:u,pixelType:f}=a.rasterInfo,{ranges:d,actualTileWidth:p,actualTileHeight:m}=a._getTileLocation(e,t,r);if(!d||0===d.length)return null;if(0===d[0].from&&0===d[0].to){const e=new Uint8Array(n*o);return new ke.a({width:n,height:o,pixels:null,mask:e,validPixelCount:0})}const{bandIds:h}=a.ioConfig,y="none"===l?1:u,b=[];let g=0;for(g=0;g<y;g++)(!h||h.indexOf[g]>-1)&&b.push(a.request(a._files.data,{range:{from:d[g].from,to:d[g].to},responseType:"array-buffer",signal:i.signal}));const x=yield Promise.all(b),O=x.map(e=>e.data.byteLength).reduce((e,t)=>e+t),v=new Uint8Array(O);let I=0;for(g=0;g<y;g++)v.set(new Uint8Array(x[g].data),I),I+=x[g].data.byteLength;const j="lerc"===a.rasterInfo.storageInfo.compression?"lerc":"bip",w=yield a.decodePixelBlock(v.buffer,{width:n,height:o,format:j,pixelType:f});let S=0,T=0;if(p!==n||m!==o){let e=w.mask;if(e)for(g=0;g<o;g++)if(T=g*n,g<m)for(S=p;S<n;S++)e[T+S]=0;else for(S=0;S<n;S++)e[T+S]=0;else for(e=new Uint8Array(n*o),w.mask=e,g=0;g<m;g++)for(T=g*n,S=0;S<p;S++)e[T+S]=1}return w})()}_parseIndex(e){if(e.byteLength%16>0)throw"invalid array buffer must be multiples of 16";let t,r,n,i,a,o;if(Fe.a){for(r=new Uint8Array(e),i=new ArrayBuffer(e.byteLength),n=new Uint8Array(i),a=0;a<e.byteLength/4;a++)for(o=0;o<4;o++)n[4*a+o]=r[4*a+3-o];t=new Uint32Array(i)}else t=new Uint32Array(e);return t}_getTileLocation(e,t,r){const{blockWidth:n,blockHeight:i,pyramidScalingFactor:a,compression:o}=this.rasterInfo.storageInfo,{width:s,height:l,bandCount:c}=this.rasterInfo,u="none"===o?1:c;let f,d,p,m=0,h=0;for(p=0;p<e;p++)h=a**p,f=Math.ceil(s/n/h),d=Math.ceil(l/i/h),m+=f*d;h=a**e,f=Math.ceil(s/n/h),d=Math.ceil(l/i/h),m+=t*f+r,m*=4*u;const y=this._storageIndex.subarray(m,m+4*u);let b=0,g=0;const x=[];for(let O=0;O<u;O++)b=y[4*O+0]*2**32+y[4*O+1],g=b+y[4*O+2]*2**32+y[4*O+3],x.push({from:b,to:g});return{ranges:x,actualTileWidth:r<f-1?n:Math.ceil(s/h)-n*(f-1),actualTileHeight:t<d-1?i:Math.ceil(l/h)-i*(d-1)}}_parseHeader(e){const t=be(e,"MRF_META/Raster");if(!t)throw new p.a("mrf:open","not a valid MRF format");const r=be(t,"Size"),n=parseInt(r.getAttribute("x"),10),i=parseInt(r.getAttribute("y"),10),a=parseInt(r.getAttribute("c"),10),o=(ge(t,"Compression")||"none").toLowerCase();if(!o||-1===["none","lerc"].indexOf(o))throw new p.a("mrf:open","currently does not support compression "+o);const s=ge(t,"DataType")||"UInt8",l=Pe.get(s);if(null==l)throw new p.a("mrf:open","currently does not support pixel type "+s);const c=be(t,"PageSize"),u=parseInt(c.getAttribute("x"),10),f=parseInt(c.getAttribute("y"),10),d=be(t,"DataValues");let m,h;if(d&&(h=d.getAttribute("NoData"),null!=h&&(m=h.trim().split(" ").map(e=>parseFloat(e)))),be(e,"MRF_META/CachedSource"))throw new p.a("mrf:open","currently does not support MRF referencing other data files");const y=be(e,"MRF_META/GeoTags"),b=be(y,"BoundingBox");if(null==b)throw new p.a("mrf:open","missing node MRF_META/GeoTags/BoundingBox");const g=parseFloat(b.getAttribute("minx")),x=parseFloat(b.getAttribute("miny")),O=parseFloat(b.getAttribute("maxx")),v=parseFloat(b.getAttribute("maxy")),I=ge(y,"Projection")||"",j=ge(e,"datafile"),w=ge(e,"IndexFile");let S;if("LOCAL_CS[]"!==I)if(I.toLowerCase().startsWith("epsg:")){const e=Number(I.slice(5));isNaN(e)||0===e||(S=new _.a({wkid:e}))}else S=je(I);const T=new M.a(g,x,O,v);T.spatialReference=S;const R=be(e,"MRF_META/Rsets"),C=parseInt(R&&R.getAttribute("scale")||"2",10),k=new W({origin:new E.a({x:T.xmin,y:T.ymax,spatialReference:S}),blockWidth:u,blockHeight:f,pyramidBlockWidth:u,pyramidBlockHeight:f,compression:o,pyramidScalingFactor:C}),F=new E.a({x:(O-g)/n,y:(v-x)/i,spatialReference:S});return{rasterInfo:new A.a({width:n,height:i,extent:T,spatialReference:S,bandCount:a,pixelType:l,pixelSize:F,noDataValue:m,storageInfo:k}),files:{mrf:this.url,index:w||this.url.replace(".mrf",".idx"),data:j||this.url.replace(".mrf",De.get(o))}}}_fetchAuxiliaryData(e){var t=this;return Object(n.a)(function*(){try{const{data:r}=yield t.request(t.url+".aux.xml",{responseType:"xml",signal:null==e?void 0:e.signal});return we(r)}catch{return null}})()}};Object(i.a)([Object(l.b)()],Be.prototype,"_files",void 0),Object(i.a)([Object(l.b)()],Be.prototype,"_storageIndex",void 0),Object(i.a)([Object(l.b)({type:String,json:{write:!0}})],Be.prototype,"datasetFormat",void 0),Be=Object(i.a)([Object(d.a)("esri.layers.support.rasterIO.MRFRaster")],Be);var Ne=Be,He=r("D/0F"),ze=r("bT0G");const Le=function(e,t){const r=e.get(t);return r&&r.values},Ee=function(e,t){const r=e.get(t);return r&&r.values[0]};let Je=class extends Q{constructor(){super(...arguments),this._files=null,this._headerInfo=null,this._bufferSize=1048576,this.datasetFormat="TIFF"}open(e){var t=this;return Object(n.a)(function*(){var r;yield t.init();const n=e?Object(a.o)(e.signal):null,{data:i}=yield t.request(t.url,{range:{from:0,to:t._bufferSize},responseType:"array-buffer",signal:n});if(!i)throw new p.a("tiffraster:open","failed to open url "+t.url);t.datasetName=t.url.slice(t.url.lastIndexOf("/")+1);const{littleEndian:o,firstIFD:s,isBigTiff:l}=Object(ze.f)(i),c=[];yield t.readIFDs(c,i,o,s,0,l?8:4,n);const u=Object(ze.c)(c),{width:f,height:d,tileWidth:m,tileHeight:h,planes:y,pixelType:b,compression:g,firstPyramidLevel:x,maximumPyramidLevel:O,pyramidBlockWidth:v,pyramidBlockHeight:I,tileBoundary:j,affine:w,metadata:S}=u,T=M.a.fromJSON(u.extent),R=T.spatialReference,C=new E.a(T?{x:T.xmin,y:T.ymax,spatialReference:R}:{x:0,y:0}),_=new W({blockWidth:m,blockHeight:h,pyramidBlockWidth:v,pyramidBlockHeight:I,compression:g,origin:C,firstPyramidLevel:x,maximumPyramidLevel:O,blockBoundary:j}),k=new E.a({x:(T.xmax-T.xmin)/f,y:(T.ymax-T.ymin)/d,spatialReference:R}),F=new A.a({width:f,height:d,bandCount:y,pixelType:b,compression:g,pixelSize:k,storageInfo:_,spatialReference:R,keyProperties:S?{BandProperties:S.bandProperties,DataType:S.dataType}:{},extent:T,statistics:S?S.statistics:null});if(null!=w&&w.length&&(F.nativeExtent=new M.a({xmin:-.5,ymin:.5-d,xmax:f-.5,ymax:.5,spatialReference:R}),F.transform=new le({polynomialOrder:1,forwardCoefficients:[w[2]+w[0]/2,w[5]-w[3]/2,w[0],w[3],-w[1],-w[4]]}),F.extent=F.transform.forwardTransform(F.nativeExtent),F.pixelSize=new E.a({x:(T.xmax-T.xmin)/f,y:(T.ymax-T.ymin)/d,spatialReference:R}),_.origin.x=-.5,_.origin.y=.5),null==(r=t.ioConfig.skipExtensions)||!r.includes("aux.xml")){const r=yield t._fetchAuxiliaryData(e);if(null!=r){var P;if(F.statistics=null!=(P=r.statistics)?P:F.statistics,F.histograms=r.histograms,r.histograms&&!Object(a.i)(F.statistics)&&(F.statistics=Object(Y.f)(r.histograms)),r.transform&&!w){F.transform=r.transform,F.nativeExtent=F.extent;const e=F.transform.forwardTransform(F.nativeExtent);F.pixelSize=new E.a({x:(e.xmax-e.xmin)/f,y:(e.ymax-e.ymin)/d,spatialReference:R}),F.extent=e}F.spatialReference||(F.spatialReference=r.spatialReference)}}if(t._set("rasterInfo",F),t._headerInfo={littleEndian:o,isBigTiff:l,ifds:c,...u},!t._headerInfo.isSupported)throw new p.a("tiffraster:open","this tiff is not supported: "+t._headerInfo.message);t.updateTileInfo()})()}fetchRawTile(e,t,r,i={}){var a=this;return Object(n.a)(function*(){var n;if(null==(n=a._headerInfo)||!n.isSupported||a.isBlockOutside(e,t,r))return null;const o=a.getTileLocation(e,t,r);if(!o)return null;const{range:s,actualTileWidth:l,actualTileHeight:c,ifd:u}=o,{data:f}=yield a.request(a.url,{range:s,responseType:"array-buffer",signal:i.signal}),{blockWidth:d,blockHeight:p}=a.getBlockWidthHeight(e),m=yield a.decodePixelBlock(f,{format:"tiff",customOptions:{headerInfo:a._headerInfo,ifd:u,offset:0,size:0},width:d,height:p,planes:null,pixelType:null});let h,y,b;if(l!==d||c!==p){let e=m.mask;if(e)for(h=0;h<p;h++)if(b=h*d,h<c)for(y=l;y<d;y++)e[b+y]=0;else for(y=0;y<d;y++)e[b+y]=0;else for(e=new Uint8Array(d*p),m.mask=e,h=0;h<c;h++)for(b=h*d,y=0;y<l;y++)e[b+y]=1}return m})()}readIFDs(e,t,r,i,a,o=4,s){var l=this;return Object(n.a)(function*(){if(!i)return null;(i>=t.byteLength||i<0)&&(t=(yield l.request(l.url,{range:{from:i+a,to:i+a+l._bufferSize},responseType:"array-buffer",signal:s})).data,a=i+a,i=0);const n=yield l.readIFD(t,r,i,a,He.a.TIFF_TAGS,o,s);if(e.push(n.ifd),!n.nextIFD)return null;yield l.readIFDs(e,t,r,n.nextIFD-a,a,o,s)})()}readIFD(e,t,r,i,a=He.a.TIFF_TAGS,o=4,s){var l=this;return Object(n.a)(function*(){if(!e)return null;const n=Object(ze.e)(e,t,r,i,a,o);if(n.success){const r=[];if(n.ifd.forEach(e=>{e.values||r.push(e)}),r.length>0){const n=r.map(e=>e.offlineOffsetSize),a=Math.min.apply(null,n.map(e=>e[0]));if(Math.min.apply(null,n.map(e=>e[0]+e[1]))-a<=l._bufferSize){const{data:n}=yield l.request(l.url,{range:{from:a,to:a+l._bufferSize},responseType:"array-buffer",signal:s});e=n,i=a,r.forEach(r=>Object(ze.d)(e,t,r,i))}}if(n.ifd.has("GEOKEYDIRECTORY")){const r=n.ifd.get("GEOKEYDIRECTORY"),a=r.values;if(a&&a.length>4){const n=a[0]+"."+a[1]+"."+a[2],o=yield l.readIFD(e,t,r.valueOffset+6-i,i,He.a.GEO_KEYS,2,s);r.data=o.ifd,r.data&&r.data.set("GEOTIFFVersion",{id:0,type:2,valueCount:1,valueOffset:null,values:[n]})}}return n}if(n.requiredBufferSize&&n.requiredBufferSize!==e.byteLength){const r=yield l.request(l.url,{range:{from:i,to:i+n.requiredBufferSize+4},responseType:"array-buffer",signal:s});return(e=r.data).byteLength<n.requiredBufferSize?null:l.readIFD(e,t,0,i,He.a.TIFF_TAGS,4,s)}})()}getTileLocation(e,t,r){const{firstPyramidLevel:n,blockBoundary:i}=this.rasterInfo.storageInfo,a=0===e?0:e-(n-1),o=this._headerInfo.ifds[a];if(!o)return null;const s=Le(o,"TILEOFFSETS");if(void 0===s)return null;const l=Le(o,"TILEBYTECOUNTS"),{minRow:c,minCol:u,maxRow:f,maxCol:d}=i[a];if(t>f||r>d||t<c||r<u)return null;const p=Ee(o,"IMAGEWIDTH"),m=Ee(o,"IMAGELENGTH"),h=Ee(o,"TILEWIDTH"),y=Ee(o,"TILELENGTH"),b=t*(d+1)+r,g=s[b],x=l[b];return null==g||null==x?null:{range:{from:g,to:g+x-1},ifd:o,actualTileWidth:r===d?p%h:h,actualTileHeight:t===f?m%y:y}}_fetchAuxiliaryData(e){var t=this;return Object(n.a)(function*(){try{const{data:r}=yield t.request(t.url+".aux.xml",{responseType:"xml",signal:null==e?void 0:e.signal});return we(r)}catch{return null}})()}};Object(i.a)([Object(l.b)()],Je.prototype,"_files",void 0),Object(i.a)([Object(l.b)()],Je.prototype,"_headerInfo",void 0),Object(i.a)([Object(l.b)()],Je.prototype,"_bufferSize",void 0),Object(i.a)([Object(l.b)({type:String,json:{write:!0}})],Je.prototype,"datasetFormat",void 0),Je=Object(i.a)([Object(d.a)("esri.layers.support.rasterDatasets.TIFFRaster")],Je);var Ae=Je;const qe=new Map;qe.set("CRF",{desc:"Cloud Raster Format",constructor:pe}),qe.set("MRF",{desc:"Meta Raster Format",constructor:Ne}),qe.set("TIFF",{desc:"GeoTIFF",constructor:Ae}),qe.set("RasterTileServer",{desc:"Raster Tile Server",constructor:Me}),qe.set("JPG",{desc:"JPG Raster Format",constructor:Te}),qe.set("PNG",{desc:"PNG Raster Format",constructor:Te}),qe.set("GIF",{desc:"GIF Raster Format",constructor:Te}),qe.set("BMP",{desc:"BMP Raster Format",constructor:Te});const Ue=Object(c.b)()({RSP_NearestNeighbor:"nearest",RSP_BilinearInterpolation:"bilinear",RSP_CubicConvolution:"cubic",RSP_Majority:"majority"});function We(){return{enabled:!this.loaded||"RasterTileServer"===this.raster.datasetFormat&&"Raster"===this.raster.tileType}}let Ge=class extends(Object(I.a)(Object(S.a)(Object(w.a)(Object(x.a)(Object(j.a)(L(Object(b.a)(y.a)))))))){constructor(...e){super(...e),this.bandIds=null,this.interpolation=null,this.legendEnabled=!0,this.isReference=null,this.listMode="show",this.sourceJSON=null,this.version=null,this.title=null,this.type="imagery-tile",this.operationalLayerType="ArcGISTiledImageServiceLayer",this.popupEnabled=!0,this.popupTemplate=null}normalizeCtorArgs(e,t){return"string"==typeof e?{url:e,...t}:e}load(e){const t=Object(a.i)(e)?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["Image Service"]},e).then(()=>this._openRaster(t),()=>this._openRaster(t))),Promise.resolve(this)}get defaultPopupTemplate(){return this.createPopupTemplate()}get fields(){var e,t;let r=[new v.a({name:"Raster.ServicePixelValue",alias:"Pixel Value",domain:null,editable:!1,length:50,type:"string"})];const n=null==(e=this.rasterInfo)||null==(t=e.attributeTable)?void 0:t.fields;if(n){const e=n.filter(e=>"oid"!==e.type&&"value"!==e.name.toLowerCase()).map(e=>{const t=e.clone();return t.name="Raster."+e.name,t});r=r.concat(e)}return r}set renderer(e){this._set("renderer",e),this.updateRenderer()}readRenderer(e,t,r){const n=t&&t.layerDefinition&&t.layerDefinition.drawingInfo&&t.layerDefinition.drawingInfo.renderer,i=Object(O.b)(n,r)||void 0;if(null!=i)return i}createPopupTemplate(e){return Object(T.a)(this,e)}write(e,t){const{raster:r}=this;return(this.loaded?"RasterTileServer"===r.datasetFormat&&("Raster"===r.tileType||"Map"===r.tileType):this.url&&/\/ImageServer(\/|\/?$)/i.test(this.url))?super.write(e,t):(t&&t.messages&&t.messages.push(new p.a("layer:unsupported",`Layers (${this.title}, ${this.id}) of type '${this.declaredClass}' are not supported in the context of '${t.origin}/${t.layerContainerType||"operational-layers"}'`,{layer:this})),null)}_openRaster(e){var t=this;return Object(n.a)(function*(){t.raster?(t.raster.rasterInfo||(yield t.raster.open()),t.url=t.raster.url):t.raster=yield class{static get supportedFormats(){const e=new Set;return qe.forEach((t,r)=>e.add(r)),e}static open(e){var t=this;return Object(n.a)(function*(){const{url:r,ioConfig:n,sourceJSON:i}=e;let a=e.datasetFormat;null==a&&r.lastIndexOf(".")&&(a=r.slice(r.lastIndexOf(".")+1).toUpperCase()),"OVR"===a||"TIF"===a?a="TIFF":"JPG"!==a&&"JPEG"!==a&&"JFIF"!==a||(a="JPG"),r.toLowerCase().indexOf("/imageserver")>-1&&-1===r.toLowerCase().indexOf("/wcsserver")&&(a="RasterTileServer");const o={url:r,sourceJSON:i,datasetFormat:a,ioConfig:n||{bandIds:null,sampling:null}};let s,l;if(t.supportedFormats.has(a))return s=qe.get(a).constructor,l=new s(o),yield l.open({signal:e.signal}),l;if(a)throw new p.a("rasterfactory:open","not a supported format "+a);const c=Array.from(qe.keys());let u=0;const f=function(){return a=c[u++],a?(s=qe.get(a).constructor,l=new s(o),l.open({signal:e.signal}).then(()=>l).catch(()=>f())):null};return f()})()}static register(e,t,r){qe.has(e.toUpperCase())||qe.set(e.toUpperCase(),{desc:t,constructor:r})}}.open({url:t.url,sourceJSON:t.sourceJSON,ioConfig:t.ioConfig,signal:e});const{rasterInfo:r}=t.raster;if(!r)throw new p.a("imagery-tile-layer:load","cannot load resources on "+t.url);t.sourceJSON=t.sourceJSON||t.raster.sourceJSON,null!=t.sourceJSON&&(t._set("version",t.sourceJSON.currentVersion),t._set("copyright",t.sourceJSON.copyrightText)),null==t.title&&(t.title=t.raster.datasetName),"Map"===t.raster.tileType&&(t.popupEnabled=!1),t._configDefaultSettings()})()}};Object(i.a)([Object(l.b)({type:[s.a],json:{write:{overridePolicy:We}}})],Ge.prototype,"bandIds",void 0),Object(i.a)([Object(l.b)({json:{write:{overridePolicy:We}}}),Object(u.a)(Ue)],Ge.prototype,"interpolation",void 0),Object(i.a)([Object(l.b)({json:{write:!0}})],Ge.prototype,"multidimensionalDefinition",void 0),Object(i.a)([Object(l.b)(g.e)],Ge.prototype,"legendEnabled",void 0),Object(i.a)([Object(l.b)({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],Ge.prototype,"isReference",void 0),Object(i.a)([Object(l.b)({type:["show","hide"]})],Ge.prototype,"listMode",void 0),Object(i.a)([Object(l.b)()],Ge.prototype,"sourceJSON",void 0),Object(i.a)([Object(l.b)({readOnly:!0})],Ge.prototype,"version",void 0),Object(i.a)([Object(l.b)()],Ge.prototype,"title",void 0),Object(i.a)([Object(l.b)({readOnly:!0,json:{read:!1}})],Ge.prototype,"type",void 0),Object(i.a)([Object(l.b)({type:["ArcGISTiledImageServiceLayer"]})],Ge.prototype,"operationalLayerType",void 0),Object(i.a)([Object(l.b)({type:Boolean,value:!0,json:{read:{source:"disablePopup",reader:(e,t)=>!t.disablePopup},write:{target:"disablePopup",overridePolicy:We,writer(e,t,r){t[r]=!e}}}})],Ge.prototype,"popupEnabled",void 0),Object(i.a)([Object(l.b)({type:h.a,json:{read:{source:"popupInfo"},write:{target:"popupInfo",overridePolicy:We}}})],Ge.prototype,"popupTemplate",void 0),Object(i.a)([Object(l.b)({readOnly:!0})],Ge.prototype,"defaultPopupTemplate",null),Object(i.a)([Object(l.b)({readOnly:!0,type:[v.a]})],Ge.prototype,"fields",null),Object(i.a)([Object(l.b)({types:O.a,json:{name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:We},origins:{"web-scene":{types:O.c,name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:e=>({enabled:e&&"vector-field"!==e.type})}}}}})],Ge.prototype,"renderer",null),Object(i.a)([Object(f.a)("renderer")],Ge.prototype,"readRenderer",null),Ge=Object(i.a)([Object(d.a)("esri.layers.ImageryTileLayer")],Ge),t.default=Ge}}]);